<!DOCTYPE html>
<html>
  <head>
    <title>WamBam!</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
  <style>
#accordion .ui-accordion-header {  
    background-color: white;  
    margin: 0px;  
}  
  </style>
    <link rel="stylesheet" type="text/css" media="screen and (min-device-width:700px)" href="{{ url_for('static', filename='tasklist.css') }}">
    <link rel="stylesheet" type="text/css" media="screen and (max-device-width:699px)" href="{{ url_for('static', filename='tasklist_mobile.css') }}">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyA3Y6rYtcBAnNDGa317n5bRdYAp3_fhgFU&sensor=false"></script>
  <script>
      var lats = [];
      var lons = [];
      var ids = [];
      var maps = [];
      var locs =[]

      function addStuff(lat, lon, id) {
          console.debug("lat: " + lat)
          lats.push(lat)
          lons.push(lon)
          ids.push(id)
      }
      $(document).ready(function(){
              console.debug(":/");
        $("#accordion").accordion({
            activate: function (event, ui) {
              var active = $("#accordion").accordion( "option", "active" );
              console.debug(active);
              google.maps.event.trigger(maps[active], "resize");
              maps[active].setCenter(locs[active]);
            }
        });
      });

      function initialize() {
        for (var i = 0; i < lats.length; i++) {
            var map;
            var mapOptions = {
            zoom: 15,
            center: new google.maps.LatLng(lats[i], lons[i])
            };

            map = new google.maps.Map(document.getElementById(ids[i]),
                                      mapOptions);

            map.setOptions({styles: [
               {
                 featureType: "poi",
                 elementType: "labels",
                 stylers: [
                   { visibility: "off" }
                 ]
               }
             ]});
              var myLatLng = new google.maps.LatLng(lats[i], lons[i]);
              var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
              });
              maps.push(map);
              locs.push(myLatLng);
            }

          for (var i = 0; i < ids.length; i++) {

          }  
        }

        google.maps.event.addDomListener(window, 'load', initialize);
  </script>
  <script>
      var div_id = "";
      var task_id = "";

      $(function() {
        console.debug("HERE");
        $( "#accordion input[type=submit]" ).click(
            function(event) {
                var form = $(this).parents('form:first');
                var input_id = $(this).attr("id");
                task_id = input_id.substring(1)
                div_id = "#d" + task_id;
                console.debug(div_id);
                if (form.attr("id") == "cancel_form") {
                    console.debug("Cancel request");
                    $.ajax({
                        url: "cancel_task/" + task_id,
                        type: 'POST',
                        async: false,
                        success: function(data) {
                            var map = $("#map-canvas" + task_id)

                            $(data).insertAfter(div_id)
                            var new_head = $(div_id).next("h3")
                            var new_div = new_head.next("div")

                            var div = $(div_id)
                            var head = div.prev("h3")
                            div.remove();
                            head.remove();
                            $("#map-canvas" + task_id).replaceWith(map);
                            $("#accordion").accordion("destroy").accordion({
                                  change: function (event, ui) { 
                                    console.debug("YAY");
                                    var active = $("#accordion").accordion( "option", "active" );
                                    google.maps.event.trigger(maps[active - 1], "reset");
                                  }
                             })
                        }
                    })
                }
                if (form.attr("id") == "thumbs_up_form") {
                    $.ajax({
                        url: "add_feedback/" + task_id + "/positive",
                        type: 'POST',
                        async: false,
                        success: function(data) {
                            var map = $("#map-canvas" + task_id)

                            $(data).insertAfter(div_id)
                            var new_head = $(div_id).next("h3")
                            var new_div = new_head.next("div")

                            var div = $(div_id)
                            var head = div.prev("h3")
                            div.remove();
                            head.remove();
                            $("#map-canvas" + task_id).replaceWith(map);
                            $("#accordion").accordion("destroy").accordion({
                                  change: function (event, ui) { 
                                    console.debug("YAY");
                                    var active = $("#accordion").accordion( "option", "active" );
                                    google.maps.event.trigger(maps[active - 1], "reset");
                                  }
                             })
                        }
                    })
                }
                if (form.attr("id") == "thumbs_down_form") {
                    $.ajax({
                        url: "add_feedback/" + task_id +  + "/negative",
                        type: 'POST',
                        async: false,
                        success: function(data) {
                            var map = $("#map-canvas" + task_id)

                            $(data).insertAfter(div_id)
                            var new_head = $(div_id).next("h3")
                            var new_div = new_head.next("div")

                            var div = $(div_id)
                            var head = div.prev("h3")
                            div.remove();
                            head.remove();
                            $("#map-canvas" + task_id).replaceWith(map);
                            $("#accordion").accordion("destroy").accordion({
                                  change: function (event, ui) { 
                                    console.debug("YAY");
                                    var active = $("#accordion").accordion( "option", "active" );
                                    google.maps.event.trigger(maps[active - 1], "reset");
                                  }
                             })
                        }
                    })
                }
                else {                
                    form.submit();
                }
         })
      });
  </script>
</head>
<body>
  {% include 'header.html' %}
  <div id="contents">

    <div id="page_title"> My Tasks </div>
    <div id="tabs">
    	<a href="my_requester_tasks">As Requester</a>
    	<span> | </span>
    	<a href="my_fulfiller_tasks">As Fulfiller</a>
    </div>

    <div id="accordion">
      
    {% for task in tasks %}
        {% include 'accordion_entry.html' %}
    {% endfor %}
    </div>
      {% for task in tasks %}
        <script> 
            addStuff({{task.lat}}, {{task.lon}}, "map-canvas{{task.task_id}}");
        </script>
      {% endfor %}
  </div>
</body>
</html>
